<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Shadama2</title>
        <link href="shadama.css" rel="stylesheet">
        <script src="ohm/ohm.min.js"></script>
        <script src="shadama-lang.js"></script>
        <script src="shadama.js" type="text/javascript"></script>
  
	<script type="text/ohm-js">
Shadama {
  TopLevel
    = (Breed | Patch | Script)*

  Breed = breed ident "(" Formals ")"
  Patch = patch ident "(" Formals ")"
  Script
    = def ident "." ident "(" Formals ")" ScriptBlock

  Formals
    = ident ("," ident)* -- list
    | empty

  ScriptBlock = "{" StatementList "}"

  Block = "{" StatementList "}"

  StatementList = Statement*

  Statement
    = Block
    | VariableStatement
    | AssignmentStatement
    | ExpressionStatement
    | IfStatement

  VariableStatement = var VariableDeclaration ";"
  VariableDeclaration = ident Initialiser?
  Initialiser = "=" AddExpression

  ExpressionStatement = AddExpression ";"
  IfStatement = if "(" Expression ")" Statement (else Statement)?

  AssignmentStatement
    = LeftHandSideExpression "=" Expression ";"

  LeftHandSideExpression
    = ident "." ident -- field
    | ident

  Expression = EqualityExpression

  EqualityExpression
    = EqualityExpression "==" RelationalExpression  -- equal
    | EqualityExpression "!=" RelationalExpression  -- notEqual
    | RelationalExpression

  RelationalExpression
    = RelationalExpression "<" AddExpression           -- lt
    | RelationalExpression ">" AddExpression           -- gt
    | RelationalExpression "<=" AddExpression          -- le
    | RelationalExpression ">=" AddExpression          -- ge
    | AddExpression

  AddExpression
    = AddExpression "+" MulExpression  -- plus
    | AddExpression "-" MulExpression -- minus
    | MulExpression

  MulExpression
    = MulExpression "*" PrimExpression  -- times
    | MulExpression "/" PrimExpression  -- divide
    | PrimExpression

  PrimExpression
    = "(" Expression ")"  -- paren
    | ident "." ident     -- field
    | PrimitiveCall
    | ident               -- variable
    | number              -- number

  PrimitiveCall
    = ident "(" Actuals ")"

  Actuals
    = Expression ("," Expression)* -- list
    | empty

  ident
    = letter (alnum | "_")*

  number
    = digit* "." digit+  -- fract
    | digit+             -- whole

  identifierStart = letter | "_"
  identifierPart = identifierStart | digit

  var = "var" ~identifierPart
  if = "if" ~identifierPart
  breed = "breed" ~identifierPart
  patch = "patch" ~identifierPart
  else = "else" ~identifierPart
  def = "def" ~identifierPart
  this = "this" ~identifierPart
  self = "self" ~identifierPart

  empty =
}
    </script>


        <script id="forward.vert" type="x-shader/x-vertex">#version 300 es
layout (location = 0) in vec2 a_index;

uniform vec2 u_resolution;
uniform float u_particleLength;
uniform sampler2D u_position;
uniform float u_amount;

out vec4 vColor;

vec4 encodeVal(vec2 pos, vec2 dir) {
    return vec4(mod(pos, u_resolution), dir);
}

void main(void) {
    vec2 zeroToOne = a_index / u_particleLength;
    vec2 oneToOne = zeroToOne * 2.0 - 1.0;
    gl_Position = vec4(oneToOne, 0, 1);

    vec4 val = texelFetch(u_position, ivec2(a_index), 0);
    vec2 dPos = val.rg; // decodePos(val);
    vec2 dDir = val.ba; // decodeDir(val);
    vec2 newPos = dPos + (dDir * u_amount);
    vColor = encodeVal(newPos, dDir);
    gl_PointSize = 1.0;
}
        </script>
        <script id="forward.frag" type="x-shader/x-fragment">#version 300 es
precision highp float;

in vec4 vColor;

out vec4 outColor;

void main(void) {
    outColor = vColor;
}
        </script>

        <script id="forwardEdgeBounce.vert" type="x-shader/x-vertex">#version 300 es
layout (location = 0) in vec2 a_index;

uniform vec2 u_resolution;
uniform float u_particleLength;
uniform sampler2D u_position;
uniform float u_amount;
uniform int u_edgeCondition[4]; // left, right, bototm, top.  0=through, 1=boucne, 2=stick

out vec4 vColor;

vec4 encodeVal(vec2 pos, vec2 dir) {
    return vec4(pos, dir);
}

void main(void) {
    vec2 zeroToOne = a_index / u_particleLength;
    vec2 oneToOne = zeroToOne * 2.0 - 1.0;
    gl_Position = vec4(oneToOne, 0, 1);

    vec4 val = texelFetch(u_position, ivec2(a_index), 0);
    vec2 maybePos = val.rg + (val.ba * u_amount);
    float px = maybePos.x;
    float py = maybePos.y;
    float dx = val.b;
    float dy = val.a;
    if (px < 0.0) {
        if (u_edgeCondition[0] == 1) {
             px = - px;
	     dx = -dx;
        } else if (u_edgeCondition[0] == 2) {
             px = 0.0;
        } else {
             // u_edgeCondition[0] == 0
	     px = mod(px, u_resolution.x);
	}
    }
    if (px > u_resolution.x) {
        if (u_edgeCondition[1] == 1) {
             px = u_resolution.x - (px - u_resolution.x);
	     dx = -dx;
        } else if (u_edgeCondition[1] == 2) {
             px = u_resolution.x;
        } else {
             // u_edgeCondition[1] == 0
	     px = mod(px, u_resolution.x);
	}
    }

    if (py < 0.0) {
        if (u_edgeCondition[2] == 1) {
             py = -py;
	     dy = -dy;
        } else if (u_edgeCondition[2] == 2) {
             py = 0.0;
        } else {
             // u_edgeCondition[2] == 0
	     py = mod(py, u_resolution.y);
	}
    }
    if (py > u_resolution.y) {
        if (u_edgeCondition[3] == 1) {
             py = u_resolution.y - (py - u_resolution.y);
	     dy = -dy;
        } else if (u_edgeCondition[3] == 2) {
             py = u_resolution.y;
        } else {
             // u_edgeCondition[3] == 0
	     py = mod(py, u_resolution.y);
	}
    }
    vColor = vec4(px, py, dx, dy);
    gl_PointSize = 1.0;
}
        </script>
        <script id="forwardEdgeBounce.frag" type="x-shader/x-fragment">#version 300 es
precision highp float;

in vec4 vColor;

out vec4 outColor;

void main(void) {
    outColor = vColor;
}
        </script>


        <script id="turn.vert" type="x-shader/x-vertex">#version 300 es
layout (location = 0) in vec2 a_index;

uniform vec2 u_resolution;
uniform float u_particleLength;
uniform sampler2D u_position;
uniform mat2 u_rot;

out vec4 vColor;

vec4 encodeVal(vec2 pos, vec2 dir) {
    return vec4(pos, dir);
}

void main(void) {
    vec2 zeroToOne = a_index / u_particleLength;
    vec2 oneToOne = zeroToOne * 2.0 - 1.0;
    gl_Position = vec4(oneToOne, 0, 1);

    vec4 val = texelFetch(u_position, ivec2(a_index), 0);
    vec2 dPos = val.rg; // decodePos(val);
    vec2 dDir = val.ba; // decodeDir(val);

    vec2 newDir = u_rot * dDir;
    vColor = encodeVal(dPos, newDir);
    gl_PointSize = 1.0;
}
        </script>
        <script id="turn.frag" type="x-shader/x-fragment">#version 300 es
precision highp float;

in vec4 vColor;

out vec4 fragColor;

void main(void) {
    fragColor = vColor;
}
        </script>

        <script id="drawBreed.vert" type="x-shader/x-vertex">#version 300 es
layout (location = 0) in vec2 a_index;

uniform vec2 u_resolution;
uniform float u_particleLength;
uniform sampler2D u_position;

out vec2 v_coord;

vec2 decodePos(vec4 c) {
    return c.rg;
}

void main(void) {
    vec2 zeroToOne = a_index / u_particleLength;

    vec4 val = texelFetch(u_position, ivec2(a_index), 0);
    vec2 dPos = decodePos(val);   // (0-resolution, 0-resolution)
    vec2 normPos = dPos / u_resolution;  // (0-1.0, 0-1.0)
    vec2 clipPos = normPos * 2.0 - 1.0;  // (-1.0-1.0, -1.0-1.0)

    v_coord = a_index;

    gl_Position = vec4(clipPos, 0, 1.0);
    gl_PointSize = 1.0;
}
        </script>

        <script id="drawBreed.frag" type="x-shader/x-fragment">#version 300 es
precision highp float;

uniform sampler2D u_color;

in vec2 v_coord;

out vec4 fragColor;

void main(void) {
  fragColor = texelFetch(u_color, ivec2(v_coord), 0);
}
        </script>
        <script id="setPatch.vert" type="x-shader/x-vertex">#version 300 es
layout (location = 0) in vec2 a_index;

uniform vec2 u_resolution;
uniform float u_particleLength;
uniform sampler2D u_position;

void main(void) {
    vec2 zeroToOne = a_index / u_particleLength;
    vec4 val = texelFetch(u_position, ivec2(a_index), 0);
    vec2 dPos = val.rg; // decodePos(val);   // (0-resolution, 0-resolution)
    vec2 normPos = dPos / u_resolution;  // (0-1.0, 0-1.0)
    vec2 clipPos = normPos * 2.0 - 1.0;  // (-1.0-1.0, -1.0-1.0)

    gl_Position = vec4(clipPos, 0, 1.0);
    gl_PointSize = 1.0;
}
        </script>

        <script id="setPatch.frag" type="x-shader/x-fragment">#version 300 es
precision highp float;
uniform vec4 u_value;
uniform int u_type; // 0 = Number, 1 = Color

out vec4 fragColor;

void main(void) {
  if (u_type == 0) {
    fragColor = u_value;
  } else if(u_type == 1) {
    fragColor = u_value;
  } else {
    discard;
  }
}
        </script>
        <script id="getPatch.vert" type="x-shader/x-vertex">#version 300 es
layout (location = 0) in vec2 a_index;

uniform vec2 u_resolution;
uniform float u_particleLength;
uniform sampler2D u_position;

out vec2 v_coord;

void main(void) {
    vec2 zeroToOne = a_index / u_particleLength;
    vec2 oneToOne = zeroToOne * 2.0 - 1.0;

    vec4 val = texelFetch(u_position, ivec2(a_index), 0);
    vec2 dPos = val.rg; // decodePos(val);   // (0-resolution, 0-resolution)
    vec2 normPos = dPos / u_resolution;  // (0-1.0, 0-1.0)

    gl_Position = vec4(oneToOne, 0, 1);
    v_coord = dPos;
    gl_PointSize = 1.0;
}
        </script>

        <script id="getPatch.frag" type="x-shader/x-fragment">#version 300 es
precision highp float;
uniform sampler2D u_value;
uniform int u_type; // 0 = Number, 1 = Color

in vec2 v_coord;

out vec4 fragColor;

void main(void) {
  if (u_type == 0) {
    fragColor = texelFetch(u_value, ivec2(v_coord), 0);
  } else if(u_type == 1) {
    fragColor = texelFetch(u_value, ivec2(v_coord), 0);
  } else {
    discard;
  }
}
        </script>
        <script id="bounceIf.vert" type="x-shader/x-vertex">#version 300 es
layout (location = 0) in vec2 a_index;

uniform vec2 u_resolution;
uniform float u_particleLength;
uniform sampler2D u_position;
uniform sampler2D u_buffer;

out vec4 vColor;

vec4 encodeVal(vec2 pos, vec2 dir) {
    return vec4(mod(pos, u_resolution), dir);
}

void main(void) {
    vec2 zeroToOne = a_index / u_particleLength;
    vec2 oneToOne = zeroToOne * 2.0 - 1.0;
    gl_Position = vec4(oneToOne, 0, 1);

    vec4 val = texelFetch(u_position, ivec2(a_index), 0);
    vec2 dPos = val.rg; // decodePos(val);
    vec2 dDir = val.ba; // decodeDir(val);

    vec2 normPos = dPos / u_resolution;  // (0-1.0, 0-1.0)

    float v = texelFetch(u_buffer, ivec2(dPos), 0).r;

    vec2 newDir;
    vec2 newPos;
    if (v > 0.25) {
      newDir = mat2(-1.0, 0.0, 0.0, -1.0) * dDir;
      //newPos = dPos + newDir * 1.4;
    } else {
      newDir = dDir;
      //newPos = dPos;
    }
    vColor = encodeVal(dPos, newDir);
    gl_PointSize = 1.0;
}
        </script>
        <script id="bounceIf.frag" type="x-shader/x-fragment">#version 300 es
precision highp float;

in vec4 vColor;

out vec4 fragColor;

void main(void) {
    fragColor = vColor;
}
        </script>
        <script id="drawPatch.vert" type="x-shader/x-vertex">#version 300 es
layout (location = 0) in vec2 a_position;

void main(void) {
    gl_Position = vec4(a_position, 0, 1.0);
}
        </script>

        <script id="drawPatch.frag" type="x-shader/x-fragment">#version 300 es
precision highp float;
uniform sampler2D u_value;
uniform int u_type;  // 0 = Number, 1 = Color

out vec4 fragColor;

void main(void) {
  ivec2 fc = ivec2(gl_FragCoord.s, gl_FragCoord.t);
  if (u_type == 0) {
    fragColor = texelFetch(u_value, fc, 0);
  } else if(u_type == 1) {
    fragColor = texelFetch(u_value, fc, 0);
  } else {
    discard;
  }
}
        </script>
        <script id="diffusePatch.vert" type="x-shader/x-vertex">#version 300 es
layout (location = 0) in vec2 a_position;

void main(void) {
    gl_Position = vec4(a_position, 0, 1.0);
}
        </script>

        <script id="diffusePatch.frag" type="x-shader/x-fragment">#version 300 es
precision highp float;
uniform vec2      u_resolution;
uniform sampler2D u_value;

const float weight[9] = float[9](
    0.077847, 0.123317, 0.077847,
    0.123317, 0.195346, 0.123317,
    0.077847, 0.123317, 0.077847
);

out vec4 fragColor;

void main(void) {
  ivec2 fc = ivec2(gl_FragCoord.s, gl_FragCoord.t);
  vec4 v  = texelFetch(u_value, fc + ivec2(-1, -1), 0) * weight[0];
       v += texelFetch(u_value, fc + ivec2(-1,  0), 0) * weight[1];
       v += texelFetch(u_value, fc + ivec2(-1,  1), 0) * weight[2];
       v += texelFetch(u_value, fc + ivec2( 0, -1), 0) * weight[3];
       v += texelFetch(u_value, fc + ivec2( 0,  0), 0) * weight[4];
       v += texelFetch(u_value, fc + ivec2( 0,  1), 0) * weight[5];
       v += texelFetch(u_value, fc + ivec2( 1, -1), 0) * weight[6];
       v += texelFetch(u_value, fc + ivec2( 1,  0), 0) * weight[7];
       v += texelFetch(u_value, fc + ivec2( 1,  1), 0) * weight[8];
       fragColor = v.r <= (1.0/256.0) ? vec4(0.0) : v;
}
        </script>
        <script id="debugPatch.vert" type="x-shader/x-vertex">#version 300 es
layout (location = 0) in vec2 a_position;

void main(void) {
    gl_Position = vec4(a_position, 0, 1.0);
}
        </script>

        <script id="debugPatch.frag" type="x-shader/x-fragment">#version 300 es
precision highp float;
uniform sampler2D u_value;

out vec4 fragColor;

void main(void) {
    ivec2 fc = ivec2(gl_FragCoord.s, gl_FragCoord.t);
    fragColor = texelFetch(u_value, fc, 0);
}
        </script>

        <script id="debugBreed.vert" type="x-shader/x-vertex">#version 300 es
layout (location = 0) in vec2 a_index;

uniform float u_particleLength;
uniform sampler2D u_value;

out vec4 v_color;

void main(void) {
    vec2 zeroToOne = a_index / u_particleLength;
    vec2 oneToOne = zeroToOne * 2.0 - 1.0;  // (-1.0-1.0, -1.0-1.0)

    v_color = texelFetch(u_value, ivec2(a_index), 0);
    gl_Position = vec4(oneToOne, 0, 1.0);
    gl_PointSize = 1.0;
}
        </script>

        <script id="debugBreed.frag" type="x-shader/x-fragment">#version 300 es
precision highp float;

in vec4 v_color;

out vec4 fragColor;

void main(void) {
    fragColor = v_color;
}
        </script>

        <script id="genericGet.vert" type="x-shader/x-vertex">#version 300 es
layout (location = 0) in vec2 a_index;

uniform vec2 u_resolution;
uniform float u_particleLength;

uniform sampler2D u_v_input;

out float v_value;

void main(void) {
    vec2 zeroToOne = a_index / u_particleLength;
    vec2 oneToOne = zeroToOne * 2.0 - 1.0;
    float val = texelFetch(u_v_input, ivec2(a_index), 0).r;
    gl_Position = vec4(oneToOne, 0, 1);
    v_value = val;
    gl_PointSize = 1.0;
}
        </script>

        <script id="genericGet.frag" type="x-shader/x-fragment">#version 300 es
precision highp float;

in float v_value;

out vec4 fragColor;

void main(void) {
    fragColor = vec4(v_value, 0, 0, 0);
}
        </script>


        <script id="genericSet.vert" type="x-shader/x-vertex">#version 300 es
layout (location = 0) in vec2 a_index;

uniform vec2 u_resolution;
uniform float u_particleLength;

uniform bool u_use_vector;
uniform sampler2D u_v_input;
uniform float u_s_input;

out float v_value;

void main(void) {
    vec2 zeroToOne = a_index / u_particleLength;
    vec2 oneToOne = zeroToOne * 2.0 - 1.0;
    float val;
    if (u_use_vector) {
      val = texelFetch(u_v_input, ivec2(a_index), 0).r;
    } else {
      val = u_s_input;
    }
    gl_Position = vec4(oneToOne, 0, 1);
    v_value = val;
    gl_PointSize = 1.0;
}
        </script>

        <script id="genericSet.frag" type="x-shader/x-fragment">#version 300 es
precision highp float;

in float v_value;

out vec4 fragColor;

void main(void) {
    fragColor = vec4(v_value, 0, 0, 0);
}
        </script>

        <script id="genericSet2.vert" type="x-shader/x-vertex">#version 300 es
layout (location = 0) in vec2 a_index;

uniform vec2 u_resolution;
uniform float u_particleLength;

uniform bool u_use_vector1;
uniform sampler2D u_v_input1;
uniform float u_s_input1;

uniform bool u_use_vector2;
uniform sampler2D u_v_input2;
uniform float u_s_input2;

out float v_value1;
out float v_value2;

void main(void) {
    vec2 zeroToOne = a_index / u_particleLength;
    vec2 oneToOne = zeroToOne * 2.0 - 1.0;
    float val1;
    if (u_use_vector1) {
      val1 = texelFetch(u_v_input1, ivec2(a_index), 0).r;
    } else {
      val1 = u_s_input2;
    }
    float val2;
    if (u_use_vector2) {
      val2 = texelFetch(u_v_input2, ivec2(a_index), 0).r;
    } else {
      val2 = u_s_input2;
    }
    gl_Position = vec4(oneToOne, 0, 1);
    v_value1 = val1;
    v_value2 = val2;
    gl_PointSize = 1.0;
}
        </script>

        <script id="genericSet2.frag" type="x-shader/x-fragment">#version 300 es
precision highp float;

in float v_value1;
in float v_value2;

layout (location = 0) out float fragData1;
layout (location = 1) out float fragData2;

void main(void) {
    fragData1 = v_value1;
    fragData2 = v_value2;
}
        </script>

	</head>
	<body>
		<div>
                   <div style="float: left">
                     <canvas id="canvas"></canvas>
                   </div>
		   <div id="code"></div>
                </div>
                <br>
		<div style="clear: left" id="readout"></div>
		<canvas id="debugCanvas1"></canvas>
	</body>
</html>
