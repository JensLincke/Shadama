<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Shadama2</title>
        <link rel="stylesheet" type="text/css" href="shadama.css">
        <link rel="stylesheet" type="text/css" href="codemirror/codemirror.css">
        <script src="codemirror/codemirror.js"></script>
        <script src="codemirror/clike.js"></script>
        <script src="ohm/ohm.min.js"></script>
        <script src="shadama.js" type="text/javascript"></script>
        <script src="shadama-tests.js" type="text/javascript"></script>

        <script id="forward.shadama" type="x-shadama">
program "Bounce"

breed Turtle (x, y, dx, dy, r, g, b, a)
breed Filler (x, y)
patch Field (nx, ny, r, g, b, a)

def setColor() {
  this.r = this.x / 512.0;
  this.g = this.y / 512.0;
  this.b = 0.0;
  this.a = 1.0;
}

def clear(field) {
  field.r = 0.0;
  field.g = 0.0;
  field.b = 0.0;
  field.a = 0.0;
  field.nx = 0.0;
  field.ny = 0.0;
}

def fillCircle(cx, cy, r, field) {
  var dx = this.x - cx;
  var dy = this.y - cy;
  var dr = sqrt(dx * dx + dy * dy);
  if (dr < r) {
    field.r = 0.2;
    field.g = 0.2;
    field.b = 0.8;
    field.a = 1.0;
    field.nx = dx / r;
    field.ny = dy / r;
  }
}

def zeroDir() {
  this.dx = 0.0;
  this.dy = 0.0;
}
 
def bounce(field) {
  var nx = field.nx;
  var ny = field.ny;
  var dx = this.dx;
  var dy = this.dy - 0.01;
  var dot = dx * nx + dy * ny;
  var rx = dx;
  var ry = dy;
  var origV = sqrt(dx * dx + dy * dy);

  if (dot < 0.0) {
    rx = dx - 2.0 * dot * nx;
    ry = dy - 2.0 * dot * ny;
    var norm = sqrt(rx * rx + ry * ry);
    rx = rx / (norm / origV);
    ry = ry / (norm / origV);
  }

  var newX = this.x + dx;
  var newY = this.y + dy;

  if (newX < 0.0) {
    newX = -newX;
    rx = -rx * 0.9;
  }
  if (newX > u_resolution.x) {
    newX = u_resolution.x - (newX - u_resolution.x);
    rx = -rx * 0.9;
  }
  if (newY < 0.0) {
    newY = mod(newY, u_resolution.y);
    ry = -0.1;
  }
  if (newY > u_resolution.y) {
    newY = u_resolution.y - (newY - u_resolution.y);
    ry = -ry;
  }

  this.x = newX;
  this.y = newY;
  this.dx = rx;
  this.dy = ry;
}

static setup() {
  Filler.fillSpace("x", "y", 512, 512);
  Turtle.setCount(300000);
  Turtle.fillRandom("x", 0, 512);
  Turtle.fillRandom("y", 256, 512);
  Turtle.fillRandomDir("dx", "dy");
  Turtle.setColor();
}

static loop() {
  Filler.clear(Field);
  Filler.fillCircle(75, 75, 20, Field);
  Filler.fillCircle(300, 95, 25, Field);
  Turtle.bounce(Field);
  Display.clear();
  Field.draw();
  Turtle.draw();
}
</script>

<script id="degauss.shadama" type="x-shadama">
program "DeGauss"
breed Pict (x, y, r, g, b, a, origX, origY, origR, origG, origB, origA)
breed Filler (x, y, r, g, b, a)
breed Button (x, y, r, g, b, a)
patch Blur (level)
  
def move(x, y) {
  this.x = this.x + x;
  this.y = this.y + y;
}

def remember1() {
  this.origX = this.x;
  this.origY = this.y;
  this.origR = this.r;
  this.origG = this.g;
  this.origB = this.b;
  this.origA = this.a;
}

def storeBlur(blur) {
  blur.level = this.b;
}

def restore() {
  this.x = this.origX;
  this.y = this.origY;
  this.r = this.origR;
  this.g = this.origG;
  this.b = this.origB;
  this.a = this.origA;
}

def colorize2(blur) {
   var p = 1.0 - blur.level;
   if (p < 0.9) {
     this.r = this.origR * p + this.origG * (1.0 - p);
     this.g = this.origG * p;
     this.b = this.origB * (1.0 - p); // p + this.origG * (1.0 - p);
     this.a = this.origA;
   }
}

def degauss(step, begin) {
  var x = step * 50.0;
  var off = step - begin;
  if (step - begin > 0.4) {
    var arg = -2.4 - off;
    x = x + (this.origY - 128) / 100.0 + (this.origX -128) / 100.0 * sin(step) * 3;
    var c = cos(x) * exp(arg);
    var s = sin(x) * exp(arg);
  
    this.x = this.origX + (this.origX - 128) * c;
    this.y = this.origY + (this.origY - 128) * s;
  }
}

def degaussColor(step, begin) {
  this.r = this.r - (this.r - this.origR) * 0.01;
  this.g = this.g - (this.g - this.origG) * 0.01;
  this.b = this.b - (this.b - this.origB) * 0.01;
}
  
static setup() {
  Pict.fillImage("x", "y", "r", "g", "b", "a", presentation);
  Pict.remember1();
  Filler.fillImage("x", "y", "r", "g", "b", "a", blurBlue);
  Filler.storeBlur(Blur);
  Button.fillImage("x", "y", "r", "g", "b", "a", button);
  Button.move(760, 160);

  Pict.colorize2(Blur);
  Pict.draw();
  var begin = -1;
  var showButton = 0;
}

static rrestore() {
  Pict.restore();
}

static loop() {
  Display.clear();
  if (mousemove.x > 950) {
    if (showButton == 0) {
      showButton = 1;
    }
    if (mousemove.y < 200) {
      if (begin == -1) {
        begin = time;
        Display.playSound("degauss");
      }
    }
  }
  if (begin != -1) {
    Pict.degauss(time, begin);
    Pict.degaussColor(time, begin);
  }
  Pict.draw();
  if (showButton == 1) {
     Button.draw();
  }
}
</script>

<script>
var shadama;
onload = function() {
  shadama = ShadamaFactory(null, 2);
}
</script>

        </head>
        <body>
          <h1 id="bigTitle">Shadama</h1>
                <div style="float: left">
                      <canvas id="shadamaCanvas"></canvas>
                </div>
                <textarea style="float: left" id="code"></textarea>
                <div style="float: left" id="controlBox">
                  <select id="myDropdown" class="dropdown-content">
                  </select>
                  <hr>
                  <div id="watcherList"></div>
                  <hr>
                  <div id="envList"></div>
                </div>
                <br>
                <div style="clear: left" id="readout"></div>
		<button onclick="shadama.goFullScreen()">Full Screen</button>
                <!-- <canvas id="debugCanvas1"></canvas> -->
        </body>
</html>
