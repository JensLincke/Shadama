
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>Shadama2</title>
		<script src="minMatrixb.js" type="text/javascript"></script>
		<script src="shadama.js" type="text/javascript"></script>

        <script id="forward.vert" type="x-shader/x-vertex">
attribute vec2 a_position;

uniform vec2 u_resolution;
uniform float u_particleLength;
uniform sampler2D u_position;
uniform float u_amount;

varying vec4 vColor;

vec2 decodePos(vec4 c) {
    return c.rg;
}

vec2 decodeDir(vec4 c) {
    return c.ba;
}

vec4 encodeVal(vec2 pos, vec2 dir) {
    return vec4(mod(pos, u_resolution), dir);
}

void main(void) {
    vec2 zeroToOne = a_position / u_particleLength;
    vec2 oneToOne = zeroToOne * 2.0 - 1.0;
    gl_Position = vec4(oneToOne, 0, 1);

    vec4 val = texture2D(u_position, zeroToOne);
    vec2 dPos = decodePos(val);
    vec2 dDir = decodeDir(val);
    vec2 newPos = dPos + (dDir * u_amount);
    vColor = encodeVal(newPos, dDir);
    gl_PointSize = 1.0;
}
        </script>
        <script id="forward.frag" type="x-shader/x-fragment">
precision mediump float;

varying vec4 vColor;

void main(void) {
    gl_FragColor = vColor;
}
        </script>

        <script id="turn.vert" type="x-shader/x-vertex">
attribute vec2 a_position;

uniform float u_particleLength;
uniform sampler2D u_position;
uniform mat2 u_rot;

varying vec4 vColor;

vec2 decodePos(vec4 c) {
    return c.rg;
}

vec2 decodeDir(vec4 c) {
    return c.ba;
}

vec4 encodeVal(vec2 pos, vec2 dir) {
    return vec4(pos, dir);
}

void main(void) {
    vec2 zeroToOne = a_position / u_particleLength;
    vec2 oneToOne = zeroToOne * 2.0 - 1.0;
    gl_Position = vec4(oneToOne, 0, 1);

    vec4 val = texture2D(u_position, zeroToOne);
    vec2 dPos = decodePos(val);
    vec2 dDir = decodeDir(val);
    
    vec2 newDir = u_rot * dDir;
    vColor = encodeVal(dPos, newDir);
    gl_PointSize = 1.0;
}
        </script>
        <script id="turn.frag" type="x-shader/x-fragment">
precision mediump float;

varying vec4 vColor;

void main(void) {
    gl_FragColor = vColor;
}
        </script>

        <script id="drawBreed.vert" type="x-shader/x-vertex">
attribute vec2 a_position;

uniform vec2 u_resolution;
uniform float u_particleLength;
uniform sampler2D u_position;

varying vec2 v_coord;

vec2 decodePos(vec4 c) {
    return c.rg;
}

void main(void) {
    vec2 zeroToOne = a_position / u_particleLength;

    vec4 val = texture2D(u_position, zeroToOne);
    vec2 dPos = decodePos(val);   // (0-resolution, 0-resolution)
    vec2 normPos = dPos / u_resolution;  // (0-1.0, 0-1.0)
    vec2 clipPos = normPos * 2.0 - 1.0;  // (-1.0-1.0, -1.0-1.0)

    v_coord = zeroToOne;

    gl_Position = vec4(clipPos, 0, 1.0);
    gl_PointSize = 1.0;
}
        </script>

        <script id="drawBreed.frag" type="x-shader/x-fragment">
precision mediump float;

uniform sampler2D u_color;

varying vec2 v_coord;

void main(void) {
  gl_FragColor = texture2D(u_color, v_coord);
}
        </script>
        <script id="setPatch.vert" type="x-shader/x-vertex">
attribute vec2 a_position;

uniform vec2 u_resolution;
uniform float u_particleLength;
uniform sampler2D u_position;

vec2 decodePos(vec4 c) {
    return c.rg;
}

void main(void) {
    vec2 zeroToOne = a_position / u_particleLength;

    vec4 val = texture2D(u_position, zeroToOne);
    vec2 dPos = decodePos(val);   // (0-resolution, 0-resolution)
    vec2 normPos = dPos / u_resolution;  // (0-1.0, 0-1.0)
    vec2 clipPos = normPos * 2.0 - 1.0;  // (-1.0-1.0, -1.0-1.0)

    gl_Position = vec4(clipPos, 0, 1.0);
    gl_PointSize = 1.0;
}
        </script>

        <script id="setPatch.frag" type="x-shader/x-fragment">
precision mediump float;
uniform vec4 u_value;
uniform int u_type; // 0 = Number, 1 = Color

void main(void) {
  if (u_type == 0) {
    gl_FragColor = u_value;
  } else if(u_type == 1) {
    gl_FragColor = u_value;
  } else {
    discard;
  }
}
        </script>
        <script id="drawPatch.vert" type="x-shader/x-vertex">
attribute vec2 a_position;

varying vec2 v_coord;

void main(void) {
    v_coord = (a_position / 2.0) + 0.5;
    gl_Position = vec4(a_position, 0, 1.0);
}
        </script>

        <script id="drawPatch.frag" type="x-shader/x-fragment">
precision mediump float;
uniform sampler2D u_value;
uniform int u_type;  // 0 = Number, 1 = Color

varying vec2 v_coord;

void main(void) {
  if (u_type == 0) {
    gl_FragColor = texture2D(u_value, v_coord);
  } else if(u_type == 1) {
    gl_FragColor = texture2D(u_value, v_coord);
  } else {
    discard;
  }
}
        </script>
        <script id="diffusePatch.vert" type="x-shader/x-vertex">
attribute vec2 a_position;

varying vec2 v_coord;

void main(void) {
    v_coord = (a_position / 2.0) + 0.5;
    gl_Position = vec4(a_position, 0, 1.0);
}
        </script>

        <script id="diffusePatch.frag" type="x-shader/x-fragment">
precision mediump float;
uniform vec2      u_resolution;
uniform sampler2D u_value;

const float weight0 = 0.077847;
const float weight1 = 0.123317;
const float weight2 = 0.077847;

const float weight3 = 0.123317;
const float weight4 = 0.195346;
const float weight5 = 0.123317;

const float weight6 = 0.077847;
const float weight7 = 0.123317;
const float weight8 = 0.077847;

void main(void) {
  vec2 onePixel = vec2(1.0) / u_resolution;
  vec2 fc = vec2(gl_FragCoord.s, gl_FragCoord.t);
  vec4 v  = texture2D(u_value, (fc + vec2(-1.0, -1.0)) * onePixel) * weight0;
       v += texture2D(u_value, (fc + vec2(-1.0,  0.0)) * onePixel) * weight1;
       v += texture2D(u_value, (fc + vec2(-1.0,  1.0)) * onePixel) * weight2;
       v += texture2D(u_value, (fc + vec2(-1.0,  0.0)) * onePixel) * weight3;
       v += texture2D(u_value, (fc + vec2( 0.0,  0.0)) * onePixel) * weight4;
       v += texture2D(u_value, (fc + vec2( 1.0,  0.0)) * onePixel) * weight5;
       v += texture2D(u_value, (fc + vec2(-1.0, -1.0)) * onePixel) * weight6;
       v += texture2D(u_value, (fc + vec2(-1.0,  0.0)) * onePixel) * weight7;
       v += texture2D(u_value, (fc + vec2( 1.0,  1.0)) * onePixel) * weight8;
       gl_FragColor = v;
}
        </script>
	</head>
	<body>
		<canvas id="canvas"></canvas>
		<canvas id="debugCanvas1"></canvas>
		<div id="readout"</div>
	</body>
</html>
